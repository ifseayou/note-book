# 阿里巴巴大数据之路

全书总的结构如下图所示：

<img src="./img/ali/01.png" width = 80% height = 70% alt="图片名称" align=center />

### 1.总述

日志的采集称为：**数据采集**；数据库数据的采集称之为**数据同步**

数据计算频率角度来看，阿里数据仓库分为:a:离线数据仓库， :b: 实时数据仓库

阿里数据仓库的数据加工链路~分层理念~

:one: 数据层(Operational Data Store, ODS)

:two: 明细数据层(Data Warehouse Detail , DWD)

:three: 汇总数据层(Data Warehouse Summary, DWS)

:four: 应用数据层(Application Data Store, ADS)

数据仓库不同层次之间 的加工过程实现从数据资产向信息资产的转化

元数据主要包括：:one:数据源元数据、:two:数据仓库元数据 、:three:数据链路元数据、:four:工 具 类元数据 、 :five:数据质量类元数据

统一的数据服务平台~OneService~ 以数据仓库整合计算好的数据作为数据源，对外通过**接口**的方式提供数据服务，主要提供:one:简单数据查询服务、:two:复杂数据查询服务(承接集团用户识别、用户画像等复 杂数据查询服务)、:three:实时数据推送服务三大特色数据服务

## 一，数据技术篇

### 2.日志采集

#### 2.1-基于浏览器/web端日志采集技术方案

##### 2.1.1-页面浏览日志采集

页面浏览日志的采集互联网产品的两大基本指标: :a:页面浏览量(Page View, PV) 和 :b:访客数(Unique Visitors, UV)的统计基础

典型的网页访问过程是以浏览器请求、服务器响应并返回所请求的内容 (大多以HTML 文档的形式)这种模式进行的，浏览器和服务器之间的通信遵守HTTP协议(~超文本传输协议，目前以HTTP1.1为主，逐渐向最新的HTTP2.0过渡~)。浏览器发起的请求被称为HTTP请求~HTTPRequest~，服务器的返回则被称为 HTTP响应~HTTPResponse~ 



<img src="./img/ali/02.png" width = 100% height = 70% alt="图片名称" align=center />

<center>访问淘宝请求和相应的过程</center>

:one: 地址栏中输人 www.taobao.com 并回车

:two: 浏览器向淘宝服务器发起HTTP请求[^a]

:three: 服务器接受并解析请求，处理结果以 HTTP 响 应 形式发回浏览器[^b]

:four: 浏览器接受懂啊服务器的响应内容，并将其展示给用户~浏览器HTML文档规范解析文档并将页面渲染在屏幕上~

> [^a]:一个标准的http请求由三部分组成：请求行~请求行3要素分别是：请求方法，请求资源URL，HTTP协议版本号~，请求报头~请求服务器时增加的附加信息，如cookie数据项~，请求正文~可选项，可忽略~
> [^b]:一个标准的http响应由三部分组成：状态行~标识服务器对此次http请求的处理结果，如200表示成功响应，404表示请求资源在服务器没有找到~，响应报头~服务器响应客户的时附带信息，如cookie，cookie是由服务器生成的~，响应正文~可选项~

上述4步中，前三部不能确保用户已确实打开页面，需要在第四步执行采集日志的动作，**在HTML文档内适当位置增加一个日志采集节点，当浏览器解析到这个节点时，将自动触发一个特定的 HTTP请求到日志采集服务器** ，流程如下图所示

<img src="./img/ali/03.png" width = 90% height = 70% alt="图片名称" align=center />



##### 2.1.2-页面交互日志采集

页面交互日志采集用户的互动行为数据 ，以便通过量化获知用户的兴趣点或者体验优化点，由于页面的交互行为无法触发浏览器加载新页面，无法使用PV的相同的逻辑来采集，阿里设计了一个**黄金令箭**的产品来处理这个问题：

:one: 在原数据管理页面注册需要采集交互日志的业务，系统将自动与之对应的交互采集代码模版

:two: 将交互采集代码模板采集代码植入目标页面，并将采集代码和需要检测的交互行为绑定

:three: 当用户在页面上产生指定行为时，采集代码和业务互动响应代码一起被触发和执行

:four: 采集代码在采集动作完成后将对应日志通过HTTP协议发送到日志服务器

##### 2.1.3-页面日志在服务器端的清洗和预处理

采集到日志服务器的日志需要进行相应的离线预处理才能使用，需要进行如下的预处理

:one: 识别流量攻击、网络爬虫和流量作弊(虚假流量)

:two: 数据缺项补正：取值归 一 、标准化处理或反向补正~根据新日志对稍早收集的日志中的个别数据项做回补或修订(例如，在用户登录后，对登录前页面日志做身份信息的回补)~

:three: 无效数据剔除

:four: 日志隔离分发。基于数据安全或者业务特性的考虑，某些日志在进入公共数据环境之前需要做隔离

原始日志经过上述处理之后， 就具备了结构化/半结构化的特征，可以方便地被RDB装载和使用

#### 2.2-无线客户端的采集

在阿里使用采集SDK完成无线客户端的日志采集，**事件**为无线客户端日志行为的最小单位，如页面事件和控件点击事件，涉及处理 Hybrid 应用~实现H5和Native日志的统一~

##### 2.2.1-页面事件

每条页面事件日志记录三类信息 : 

* 设备及用户的基本信息
* 被访问页面的信息，主要是一些业务参数(如商品详情页的商品 ID、所属的店铺等) 
* 访问基本路径(如页面来源、来源的来源等 )，用于还原用户完整的访问行为

具体的实现可能是下面这样的：

* 基础接口A：页面展现时调用，但是不发送日志
* 基础接口B：页面关闭时调用，发送日志~接口AB的结合可以获取用户在页面停留的时长~
* 扩展接口C：页面离开前，使用该接口给页面添加相关参数，比如给店铺详情页添加店铺ID、店铺类别等

> 透传参数功能：即把当前页面的某些信息，传递到下一个页面甚至下下一个页面的日志中。如，在手机淘宝首页搜索“连衣裙”，进人 搜索list页面，然后点击某个商品进入商品A详情页，“连衣裙”参数一直传下去，如此便于分析搜索词的效果

##### 2.2.2-点控事件

交互类的行为呈现出高度自定义的业务特征，相对而言，控件点击事件比页面事件要简单得多，点控事件需要记录：

* 基本的设备信息、用户信息
* 控件所在页面名称、控件名称、控件的业务参数

具体要操作页面上哪个控件，告诉~配置~SDK即可，特殊场景下，为平衡日志大小，减小流量消耗/采集服务器压力/网络传输压力，采集 SDK应提供了聚合功能，如客户端聚合曝光次数后上传~1次滚屏场次会产生多次曝光生产多条日志~

##### 2.2.3-H5/Native 日志统一

现在的应用几乎都是HybridAPP，多数情况下情况下， Native和H5互跳，通常无法还原用户路径，数据丢失严重。对于产品经理/运营/管理/数据分析人员而言，在不同的终端采用不同的方案采集日志， 以不同的算法来做日志统计，忍受多端之间的数据隔离，并对由此导致 的多样数据口径进行整理分析和解释，已经是越来越不能容忍的切身之痛

阿里实现了H5和Native的日志统一

##### 2.2.4-其他

:one: 全局设备唯一标识

:two: 日志传输：

* 先存储在客户端本地，然后再伺机上传
* 按天切分维度，日志分流~高峰时可降级，只保留重要日志~
* 日志采集服务器同时作为**消息队列**的生产者，下游实时~实时消费~和离线~定期获取~可以按需订阅

#### 2.3-日志采集的挑战

互联网日志已跨越初级的饥饿阶段，面临被海量日志的淹没的风险，如今，采集方案提供者所面临的主要挑战是

* 如何实现日志数据的结构化和规范化组织，实现更高效的下游统计计算
* 提供符合业务特性的数据展现
* 为算法提供更便捷、灵活的支持

### 3.数据同步

对于大数据系统来说，数据同步包含:a: 数据从业务系统同步进入数据仓库，:b:数据从数据仓库同步进入数据服务或数据应用两个方面。源业务数据系统的来源：:one:关系型数据库的结构化数据~mysql,Oracle,DB2等~ ，:two: 非关系型数据库的半结构化数据~OceanBase,HBase,MongoDB~，:three: 文件系统的结构化或非结构化数据~阿里云对象存储oss、文件存储NAS~

同步方式分为：

* 直连同步 
* 数据文件同步
* 数据库日志解析同步

#### 3.1-直连同步

直连同步是指通过定义好的规范接口API~ODBC/JDBC~的方式直接连接业务库，

:heart:优势是：配置简单，实现容易

:broken_heart:劣势是：

* 直连业务库对源系统的性能影响较大，大批量数据同步时会降低甚至拖垮业务系统的性能
* 主备策略时，从备库抽取数据可以避免情况一，但是当数据量较大时，性能较差

<img src="./img/ali/04.png" width = 70% height = 70% alt="图片名称" align=center />



#### 3.2-数据文件同步

数据文件同步通过约定好的文件编码、大小、格式等，直接从源系统生成数据的文本文件，由专门的文件服务器~如FTP服务器~传输到目标系统后加载到目标数据库系统。文件传输可加密，压缩，生产校验码等，来确保文件的安全，无错，高效传输

:heart: 优势是：

* 当数据源系统包含多的异构数据库系统~MySQL,Oracle,SQLServer,DB2~，这种方式比较简单，容易

* 互联网的日志类数据，通常以文本文件形式存储的，适合数据文件同步的方式

<img src="./img/ali/05.png" width = 70% height = 70% alt="图片名称" align=center />



#### 3.3-数据库日志解析同步

数据库日志解析同步方式具备实时与准实时同步的能力，延迟可以控制在毫秒级别，且对业务系统的性能影响较小，目前广泛应用于业务系统到数据仓库系统的增量数据同步

> 以 Oracle 为例，可以通过源系统的进程，读取归档日志文件并收集变化的数据信息，判断日志中的变更是否属于被收集对象，将其 解析到目标数据文件中。这种读操作是在操作系统层面完成的，不需要通过数据库，不会给源系统带来性能影响

:heart: 优势：延迟可以控制在毫秒级别，且对业务系统的性能影响较小

:broken_heart: 劣势：

* 数据延迟：业务系统做批量补录可能会使数据更新量超出系统处理峰值，导致数据延迟
* 投人较大：需要在源数据库与目标数据库之间部署一个系统实时抽取数据
* 数据漂移和遗漏：同一个业务日期数据中包含前一天或后一天凌晨附近的数据或者丢失当天的变更数据























